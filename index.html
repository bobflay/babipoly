<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Babipoly — Supply Chain Tracker</title>
  <style>
    :root {
      --primary: #1a2332;
      --primary-light: #2c3e50;
      --accent: #3498db;
      --accent-dark: #2980b9;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --light: #f4f6f9;
      --border: #dde3ea;
      --text: #2c3e50;
      --text-muted: #7f8c8d;
      --card: #ffffff;
      --radius: 10px;
      --shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--light);
      color: var(--text);
      min-height: 100vh;
    }

    /* ── HEADER ── */
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      padding: 0;
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 32px 16px;
      flex-wrap: wrap;
      gap: 16px;
    }
    .header-brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .brand-icon {
      width: 48px; height: 48px;
      border-radius: 12px;
      flex-shrink: 0;
      overflow: hidden;
    }
    .brand-icon img {
      width: 100%; height: 100%;
      object-fit: cover;
    }
    .brand-text h1 { font-size: 22px; font-weight: 700; letter-spacing: 0.5px; }
    .brand-text p  { font-size: 12px; opacity: 0.7; margin-top: 2px; }

    .header-stats {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }
    .stat-pill {
      text-align: center;
    }
    .stat-pill .val { font-size: 26px; font-weight: 700; color: #fff; line-height: 1; }
    .stat-pill .lbl { font-size: 11px; opacity: 0.65; margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px; }

    .header-progress {
      padding: 12px 32px 0;
      background: rgba(0,0,0,0.15);
    }
    .progress-bar-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 0;
    }
    .progress-label { font-size: 13px; opacity: 0.8; white-space: nowrap; }
    .progress-track {
      flex: 1;
      height: 10px;
      background: rgba(255,255,255,0.2);
      border-radius: 99px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #27ae60, #2ecc71);
      border-radius: 99px;
      transition: width 0.5s ease;
    }
    .progress-pct { font-size: 14px; font-weight: 700; min-width: 40px; text-align: right; }

    /* ── NAV TABS ── */
    nav.tabs {
      background: var(--primary-light);
      display: flex;
      padding: 0 32px;
      gap: 4px;
      border-bottom: 3px solid var(--primary);
    }
    nav.tabs button {
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      font-weight: 600;
      padding: 13px 18px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -3px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    nav.tabs button:hover  { color: rgba(255,255,255,0.9); }
    nav.tabs button.active { color: #fff; border-bottom-color: var(--accent); }
    nav.tabs a {
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      font-weight: 600;
      padding: 13px 18px;
      text-decoration: none;
      border-bottom: 3px solid transparent;
      margin-bottom: -3px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    nav.tabs a:hover { color: rgba(255,255,255,0.9); }

    /* ── MAIN CONTENT ── */
    main { max-width: 1200px; margin: 0 auto; padding: 28px 24px; }
    .tab-section { display: none; }
    .tab-section.active { display: block; }

    /* ── SECTION HEADERS ── */
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title::after {
      content: '';
      flex: 1;
      height: 2px;
      background: var(--border);
      border-radius: 1px;
    }

    /* ── OVERVIEW CARDS GRID ── */
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    .comp-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      border-left: 4px solid var(--border);
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .comp-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
    .comp-card.status-todo    { border-left-color: var(--border); }
    .comp-card.status-active  { border-left-color: var(--warning); }
    .comp-card.status-done    { border-left-color: var(--success); }

    .comp-card-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 14px;
    }
    .comp-icon {
      font-size: 28px;
      line-height: 1;
      flex-shrink: 0;
    }
    .comp-card-header-text h3 { font-size: 15px; font-weight: 700; }
    .comp-card-header-text p  { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    .comp-card-progress { margin-bottom: 10px; }
    .mini-track {
      height: 7px;
      background: #eef0f3;
      border-radius: 99px;
      overflow: hidden;
      margin-top: 5px;
    }
    .mini-fill {
      height: 100%;
      border-radius: 99px;
      background: linear-gradient(90deg, var(--accent), #27ae60);
      transition: width 0.4s ease;
    }
    .comp-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }
    .stage-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 99px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .badge-todo    { background: #eef0f3; color: #7f8c8d; }
    .badge-active  { background: #fef9e7; color: #f39c12; }
    .badge-done    { background: #eafaf1; color: #27ae60; }

    /* ── SUMMARY STATS ROW ── */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      text-align: center;
    }
    .stat-card .num {
      font-size: 36px;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 6px;
    }
    .stat-card .txt { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card.s-total   .num { color: var(--primary); }
    .stat-card.s-active  .num { color: var(--warning); }
    .stat-card.s-done    .num { color: var(--success); }
    .stat-card.s-tasks   .num { color: var(--accent); }

    /* ── COMPONENT ACCORDION ── */
    .comp-accordion { display: flex; flex-direction: column; gap: 12px; }

    .acc-item {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .acc-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 18px 20px;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
    }
    .acc-header:hover { background: #f9fafb; }

    .acc-icon { font-size: 24px; flex-shrink: 0; }
    .acc-title { flex: 1; }
    .acc-title h3 { font-size: 15px; font-weight: 700; }
    .acc-title p  { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

    .acc-meta {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .acc-pct { font-size: 20px; font-weight: 800; color: var(--primary); min-width: 50px; text-align: right; }
    .acc-chevron {
      font-size: 18px;
      color: var(--text-muted);
      transition: transform 0.2s;
      line-height: 1;
    }
    .acc-item.open .acc-chevron { transform: rotate(180deg); }

    .acc-progress-bar {
      height: 4px;
      background: #eef0f3;
    }
    .acc-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--success));
      transition: width 0.4s;
    }

    .acc-body {
      display: none;
      padding: 0 20px 20px;
    }
    .acc-item.open .acc-body { display: block; }

    /* ── STAGE PIPELINE ── */
    .stage-pipeline {
      display: flex;
      gap: 0;
      margin: 20px 0;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .stage-step {
      flex: 1;
      min-width: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .stage-step::before {
      content: '';
      position: absolute;
      top: 18px;
      left: 50%;
      right: -50%;
      height: 2px;
      background: var(--border);
      z-index: 0;
    }
    .stage-step:last-child::before { display: none; }
    .stage-step.done::before { background: var(--success); }
    .stage-step.active::before { background: linear-gradient(90deg, var(--warning), var(--border)); }

    .stage-dot {
      width: 36px; height: 36px;
      border-radius: 50%;
      border: 3px solid var(--border);
      background: #fff;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      z-index: 1;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .stage-step.done   .stage-dot { border-color: var(--success); background: var(--success); color: #fff; }
    .stage-step.active .stage-dot { border-color: var(--warning); background: var(--warning); color: #fff; box-shadow: 0 0 0 4px rgba(243,156,18,0.2); }

    .stage-label {
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      margin-top: 8px;
      color: var(--text-muted);
      line-height: 1.3;
    }
    .stage-step.done   .stage-label { color: var(--success); }
    .stage-step.active .stage-label { color: var(--warning); }

    /* ── TASKS SECTIONS ── */
    .tasks-grid { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }

    .task-stage-block {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    .task-stage-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 11px 14px;
      background: #f8fafc;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
    }
    .task-stage-header:hover { background: #f0f4f8; }
    .task-stage-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .task-stage-header h4 { flex: 1; font-size: 13px; font-weight: 700; }
    .task-stage-count { font-size: 11px; color: var(--text-muted); }
    .task-stage-chevron { font-size: 12px; color: var(--text-muted); transition: transform 0.2s; }
    .task-stage-block.open .task-stage-chevron { transform: rotate(180deg); }

    .task-list { display: none; padding: 8px 14px 14px; }
    .task-stage-block.open .task-list { display: block; }

    .task-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 7px 0;
      border-bottom: 1px solid #f0f4f8;
    }
    .task-item:last-child { border-bottom: none; }

    .task-item input[type="checkbox"] {
      width: 17px; height: 17px;
      margin-top: 1px;
      cursor: pointer;
      accent-color: var(--success);
      flex-shrink: 0;
    }
    .task-item label {
      font-size: 13px;
      cursor: pointer;
      line-height: 1.4;
      color: var(--text);
    }
    .task-item.checked label {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    /* ── SUPPLIER CARD ── */
    .supplier-section {
      margin-top: 20px;
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }
    .supplier-section h4 { font-size: 13px; font-weight: 700; color: var(--primary); margin-bottom: 12px; }

    .supplier-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }

    .supplier-card {
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: border-color 0.15s, box-shadow 0.15s;
      position: relative;
    }
    .supplier-card:hover { border-color: var(--accent); box-shadow: 0 2px 8px rgba(52,152,219,0.15); }
    .supplier-card.selected { border-color: var(--success); background: #f0faf5; }

    .supplier-selected-badge {
      position: absolute;
      top: 8px; right: 8px;
      background: var(--success);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 99px;
    }
    .supplier-card h5 { font-size: 12px; font-weight: 700; margin-bottom: 4px; padding-right: 50px; }
    .supplier-card .s-city { font-size: 11px; color: var(--text-muted); }
    .supplier-card .s-spec { font-size: 11px; color: var(--accent); margin-top: 6px; }
    .supplier-card .s-contact { font-size: 10px; color: var(--text-muted); margin-top: 4px; font-style: italic; }
    .supplier-card .s-website { font-size: 10px; margin-top: 4px; }
    .supplier-card .s-website a { color: var(--accent); text-decoration: none; word-break: break-all; }
    .supplier-card .s-website a:hover { text-decoration: underline; }

    /* ── SUPPLIER DIRECTORY ── */
    .supplier-dir-grid {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .supplier-dir-comp {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .supplier-dir-comp-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: var(--primary);
      color: #fff;
    }
    .supplier-dir-comp-header .d-icon { font-size: 20px; }
    .supplier-dir-comp-header h3 { font-size: 15px; font-weight: 700; flex: 1; }
    .supplier-table {
      width: 100%;
      border-collapse: collapse;
    }
    .supplier-table th {
      background: #f4f6f9;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      padding: 10px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .supplier-table td {
      padding: 12px 16px;
      font-size: 13px;
      border-bottom: 1px solid #f0f4f8;
      vertical-align: top;
    }
    .supplier-table tr:last-child td { border-bottom: none; }
    .supplier-table tr:hover td { background: #f9fafb; }
    .selected-row td { background: #f0faf5 !important; }
    .s-name-cell { font-weight: 600; }
    .s-check { color: var(--success); font-weight: 700; font-size: 16px; }

    /* ── TIMELINE ── */
    .timeline-table-wrap { overflow-x: auto; }
    .timeline-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }
    .timeline-table th {
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #fff;
      text-align: center;
    }
    .timeline-table th:first-child { text-align: left; background: var(--primary); }
    .th-design    { background: #8e44ad; }
    .th-rfq       { background: #2980b9; }
    .th-sample    { background: #d35400; }
    .th-prod      { background: #16a085; }
    .th-qc        { background: #c0392b; }
    .th-ship      { background: #27ae60; }

    .timeline-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      text-align: center;
    }
    .timeline-table td:first-child { text-align: left; font-weight: 600; }
    .timeline-table tr:last-child td { border-bottom: none; }
    .timeline-table tr:hover td { background: #f9fafb; }

    .tl-cell {
      border-radius: 6px;
      padding: 5px 8px;
      font-size: 11px;
      font-weight: 700;
    }
    .tl-done    { background: #eafaf1; color: var(--success); }
    .tl-active  { background: #fef9e7; color: var(--warning); }
    .tl-todo    { background: #f4f6f9; color: var(--text-muted); }
    .tl-na      { color: #d0d5dd; }

    .tl-comp-name { display: flex; align-items: center; gap: 8px; }

    /* ── UTILITIES ── */
    .mt-4 { margin-top: 4px; }
    .mt-8 { margin-top: 8px; }
    .mt-16 { margin-top: 16px; }
    .text-muted { color: var(--text-muted); font-size: 12px; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid transparent;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-outline {
      border-color: var(--border);
      background: #fff;
      color: var(--text);
    }
    .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

    .btn-danger-outline {
      border-color: #fcdede;
      background: #fff;
      color: var(--danger);
      font-size: 12px;
      padding: 6px 12px;
    }
    .btn-danger-outline:hover { background: #fef0f0; }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      margin-top: 12px;
    }

    .info-chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #eef5ff;
      color: var(--accent);
      border-radius: 99px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
    }

    /* ── EMPTY STATE ── */
    .empty { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty p { margin-top: 8px; font-size: 13px; }

    /* ── RESPONSIVE ── */
    @media (max-width: 640px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .header-top { padding: 16px; }
      .header-progress { padding: 10px 16px 0; }
      nav.tabs { padding: 0 16px; overflow-x: auto; }
      main { padding: 20px 14px; }
      .stage-pipeline { gap: 0; }
      .stage-label { font-size: 9px; }
    }

    /* ── LOADING OVERLAY ── */
    #loading-overlay {
      position: fixed;
      inset: 0;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
      gap: 16px;
      transition: opacity 0.4s ease;
    }
    #loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── SYNC INDICATOR ── */
    #sync-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 5px 12px;
      border-radius: 99px;
      font-weight: 600;
      background: rgba(255,255,255,0.1);
      white-space: nowrap;
    }
    #sync-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #27ae60;
      flex-shrink: 0;
    }
    #sync-status.syncing #sync-dot { background: var(--warning); animation: pulse 1s ease infinite; }
    #sync-status.offline #sync-dot { background: var(--danger); animation: none; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* ── SIMULATION TAB ── */
    .sim-section-hd {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 22px;
      background: linear-gradient(135deg, #1a2332, #2c3e50);
      color: #fff;
      border-radius: 10px 10px 0 0;
    }
    .sim-section-num {
      display: flex; align-items: center; justify-content: center;
      width: 36px; height: 36px; min-width: 36px;
      background: var(--accent); color: #fff;
      font-size: 1rem; font-weight: 900; border-radius: 50%;
    }
    .sim-section-title { font-size: 1.05rem; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; }
    .sim-block { background: var(--card); border-radius: 10px; box-shadow: var(--shadow); margin-bottom: 22px; overflow: hidden; }
    .sim-block-body { padding: 20px 22px; }
    .sim-sub-title {
      font-size: 0.78rem; font-weight: 800; color: var(--primary);
      text-transform: uppercase; letter-spacing: 1px;
      margin-bottom: 12px; padding-bottom: 5px;
      border-bottom: 2px solid var(--accent); display: inline-block;
    }
    .sim-stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(155px,1fr)); gap: 14px; margin-top: 8px; }
    .sim-stat-card { border-radius: 8px; padding: 14px; text-align: center; }
    .sim-stat-card.red    { background:#fff0f0; border:1px solid #ffcccc; }
    .sim-stat-card.amber  { background:#fff8e1; border:1px solid #ffe082; }
    .sim-stat-card.green  { background:#f0fff4; border:1px solid #b2dfdb; }
    .sim-stat-card.blue   { background:#e8f4fd; border:1px solid #90caf9; }
    .sim-stat-card .sv    { font-size: 1.5rem; font-weight: 900; line-height: 1; }
    .sim-stat-card.red   .sv  { color: #c62828; }
    .sim-stat-card.amber .sv  { color: #e65100; }
    .sim-stat-card.green .sv  { color: #2e7d32; }
    .sim-stat-card.blue  .sv  { color: #1565c0; }
    .sim-stat-card .sl    { font-size: 0.7rem; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 5px; }

    .sim-complete-tbl { width:100%; border-collapse:collapse; font-size:0.85rem; }
    .sim-complete-tbl th { background:#f5f5f5; padding:8px 11px; text-align:left; font-weight:700; font-size:0.73rem; text-transform:uppercase; letter-spacing:0.5px; color:#666; border-bottom:2px solid #e0e0e0; }
    .sim-complete-tbl td { padding:9px 11px; border-bottom:1px solid #f0f0f0; vertical-align:middle; }
    .sim-complete-tbl tr:last-child td { border-bottom:none; }
    .bar-w { display:flex; align-items:center; gap:8px; }
    .bar-t { flex:1; height:9px; background:#e0e0e0; border-radius:5px; overflow:hidden; }
    .bar-f { height:100%; border-radius:5px; }
    .bar-f.bg-good { background:#66bb6a; } .bar-f.bg-warn { background:#ffa726; } .bar-f.bg-bad { background:#ef5350; }
    .bv { font-weight:700; font-size:0.82rem; min-width:34px; text-align:right; }
    .bv.good{color:#2e7d32;} .bv.warn{color:#e65100;} .bv.bad{color:#c62828;}
    .sim-pill { display:inline-block; padding:2px 9px; border-radius:12px; font-size:0.72rem; font-weight:700; }
    .sim-pill.red   { background:#ffcdd2; color:#b71c1c; }
    .sim-pill.amber { background:#ffe0b2; color:#e65100; }
    .sim-pill.green { background:#c8e6c9; color:#1b5e20; }

    .sim-flow { display:flex; align-items:stretch; border-radius:8px; overflow:hidden; border:1px solid #e0e0e0; margin-top:12px; }
    .sim-flow-box { flex:1; padding:14px 10px; text-align:center; }
    .sim-flow-box .fl  { font-size:0.68rem; font-weight:700; text-transform:uppercase; letter-spacing:0.4px; color:#888; }
    .sim-flow-box .fv  { font-size:1.2rem; font-weight:900; margin:3px 0 2px; }
    .sim-flow-box .fs  { font-size:0.72rem; color:#666; }
    .sim-flow-box.bank   { background:#e8f4fd; } .sim-flow-box.bank .fv   { color:#1565c0; }
    .sim-flow-box.rent   { background:#f3e5f5; } .sim-flow-box.rent .fv   { color:#6a1b9a; }
    .sim-flow-box.danger { background:#fff3e0; } .sim-flow-box.danger .fv { color:#e65100; }
    .sim-flow-sep { display:flex; align-items:center; padding:0 6px; background:#f5f5f5; font-size:1rem; color:#aaa; }

    .sim-note { border-radius:7px; padding:12px 16px; font-size:0.84rem; line-height:1.6; margin-top:11px; }
    .sim-note.warn  { background:#fff8e1; border-left:4px solid #ffa726; color:#5d3a00; }
    .sim-note.info  { background:#e8f4fd; border-left:4px solid #42a5f5; color:#0d2c4d; }
    .sim-note.good  { background:#f1f8e9; border-left:4px solid #66bb6a; color:#1b3a10; }
    .sim-note.error { background:#ffebee; border-left:4px solid #ef5350; color:#4a0000; }

    .sim-fix-card { border:1px solid #e8e8e8; border-radius:8px; overflow:hidden; margin-bottom:12px; }
    .sim-fix-hd { display:flex; align-items:center; justify-content:space-between; padding:9px 15px; background:#f9f9f9; border-bottom:1px solid #e8e8e8; flex-wrap:wrap; gap:6px; }
    .sim-fix-title { font-weight:800; font-size:0.9rem; color:var(--primary); }
    .sim-pri { display:inline-block; padding:2px 9px; border-radius:20px; font-size:0.68rem; font-weight:700; letter-spacing:0.5px; text-transform:uppercase; }
    .sim-pri.p1 { background:#b71c1c; color:#fff; } .sim-pri.p2 { background:#e65100; color:#fff; }
    .sim-pri.p3 { background:#f9a825; color:#fff; } .sim-pri.p4 { background:#558b2f; color:#fff; }
    .sim-fix-body { padding:13px 15px; }
    .sim-ba { display:flex; gap:10px; margin-top:9px; flex-wrap:wrap; }
    .sim-ba-box { flex:1; min-width:110px; padding:9px 12px; border-radius:6px; text-align:center; }
    .sim-ba-box.before { background:#fff3f3; border:1px solid #ffcdd2; }
    .sim-ba-box.after  { background:#f0fff4; border:1px solid #c8e6c9; }
    .sim-ba-box .bl { font-size:0.67rem; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; }
    .sim-ba-box.before .bl { color:#c62828; } .sim-ba-box.after .bl { color:#2e7d32; }
    .sim-ba-box .bv2 { font-size:1.05rem; font-weight:900; margin-top:2px; }
    .sim-ba-box.before .bv2 { color:#c62828; } .sim-ba-box.after .bv2 { color:#2e7d32; }
    .sim-ba-arrow { display:flex; align-items:center; padding-top:22px; font-size:1.1rem; color:#aaa; }
    .sim-impact { display:inline-block; margin-top:7px; padding:3px 9px; border-radius:4px; font-size:0.72rem; font-weight:700; background:#e8f4fd; color:#1565c0; border:1px solid #90caf9; }

    .sim-cmp-tbl { width:100%; border-collapse:collapse; font-size:0.84rem; }
    .sim-cmp-tbl thead th { padding:9px 13px; text-align:center; font-weight:700; font-size:0.73rem; text-transform:uppercase; letter-spacing:0.4px; }
    .sim-cmp-tbl thead th:first-child { text-align:left; }
    .sim-cmp-tbl th.col-c  { background:#fafafa; color:#888; border-bottom:3px solid #ccc; }
    .sim-cmp-tbl th.col-a  { background:#fff8e1; color:#e65100; border-bottom:3px solid #ffa726; }
    .sim-cmp-tbl th.col-r  { background:#e8f5e9; color:#2e7d32; border-bottom:3px solid #66bb6a; }
    .sim-cmp-tbl tbody td { padding:9px 13px; border-bottom:1px solid #f0f0f0; vertical-align:middle; }
    .sim-cmp-tbl tbody tr:last-child td { border-bottom:none; }
    .sim-cmp-tbl tbody td:first-child { font-weight:700; color:#333; background:#fafafa; }
    .sim-cmp-tbl td.col-c  { text-align:center; color:#666; background:#fafafa; }
    .sim-cmp-tbl td.col-a  { text-align:center; color:#e65100; background:#fff8e1; font-weight:700; }
    .sim-cmp-tbl td.col-r  { text-align:center; color:#2e7d32; background:#f1f8e9; font-weight:700; }
    .sim-cmp-tbl td.unch   { color:#aaa; font-style:italic; font-weight:400 !important; text-align:center; }

    .sim-roi-tbl { width:100%; border-collapse:collapse; font-size:0.84rem; }
    .sim-roi-tbl th { padding:7px 11px; text-align:left; font-size:0.72rem; font-weight:700; text-transform:uppercase; letter-spacing:0.4px; color:#666; background:#f5f5f5; border-bottom:2px solid #e0e0e0; }
    .sim-roi-tbl td { padding:8px 11px; border-bottom:1px solid #f0f0f0; vertical-align:middle; }
    .sim-roi-tbl tr:last-child td { border-bottom:none; }
    .gdot { display:inline-block; width:11px; height:11px; border-radius:50%; margin-right:7px; vertical-align:middle; }
    .roi-bw { display:flex; align-items:center; gap:7px; }
    .roi-bt { width:90px; height:7px; background:#e0e0e0; border-radius:4px; overflow:hidden; }
    .roi-bf { height:100%; border-radius:4px; }
    .sim-flag { font-size:0.75rem; color:#c62828; font-weight:700; }

    .sim-steps { list-style:none; padding:0; }
    .sim-steps li { display:flex; gap:12px; padding:9px 0; border-bottom:1px solid #f0f0f0; align-items:flex-start; }
    .sim-steps li:last-child { border-bottom:none; }
    .sim-step-num { display:flex; align-items:center; justify-content:center; min-width:26px; height:26px; background:var(--accent); color:#fff; font-size:0.8rem; font-weight:900; border-radius:50%; margin-top:2px; }
    .sim-step-title { font-weight:800; color:var(--primary); font-size:0.88rem; }
    .sim-step-desc  { font-size:0.82rem; color:#555; margin-top:2px; }
    code { background:#f0f4f8; padding:1px 5px; border-radius:3px; font-size:0.82rem; }

    @media (max-width:540px) { .sim-stat-grid { grid-template-columns:1fr 1fr; } .sim-ba { flex-direction:column; } .sim-ba-arrow { display:none; } }

    /* ── PRINT ── */
    @media print {
      nav.tabs, .actions-row { display: none; }
      .tab-section { display: block !important; }
      .acc-body { display: block !important; }
      .task-list { display: block !important; }
    }

    /* ── AUTH OVERLAY ── */
    #auth-overlay {
      position: fixed;
      inset: 0;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    #auth-overlay.hidden { display: none; }
    .auth-box {
      background: var(--primary-light);
      border-radius: 16px;
      padding: 40px 48px;
      text-align: center;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.4);
    }
    .auth-box img {
      width: 72px;
      height: 72px;
      object-fit: cover;
      border-radius: 14px;
      margin-bottom: 16px;
    }
    .auth-box h2 {
      color: #fff;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }
    .auth-box p {
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      margin-bottom: 28px;
    }
    .auth-box input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.07);
      color: #fff;
      font-size: 15px;
      outline: none;
      margin-bottom: 12px;
      letter-spacing: 1px;
    }
    .auth-box input::placeholder { color: rgba(255,255,255,0.3); }
    .auth-box input:focus { border-color: var(--accent); }
    .auth-box button {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 0.5px;
      transition: background 0.2s;
    }
    .auth-box button:hover { background: var(--accent-dark); }
    .auth-error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 10px;
      min-height: 16px;
    }
  </style>
  <script>
    (function() {
      if (sessionStorage.getItem('babipoly_auth') === '1') {
        document.addEventListener('DOMContentLoaded', function() {
          var el = document.getElementById('auth-overlay');
          if (el) el.classList.add('hidden');
        });
      }
    })();
  </script>
</head>
<body>

<!-- ── AUTH OVERLAY ── -->
<div id="auth-overlay">
  <div class="auth-box">
    <img src="rfq/logo.jpg" alt="Babipoly">
    <h2>BABIPOLY</h2>
    <p>Supply Chain Tracker</p>
    <input type="password" id="auth-input" placeholder="Enter password" autocomplete="current-password">
    <button onclick="checkAuth()">Unlock</button>
    <div class="auth-error" id="auth-error"></div>
  </div>
</div>
<script>
  function checkAuth() {
    var val = document.getElementById('auth-input').value;
    if (val === 'babipoly@2026') {
      sessionStorage.setItem('babipoly_auth', '1');
      document.getElementById('auth-overlay').classList.add('hidden');
    } else {
      var err = document.getElementById('auth-error');
      err.textContent = 'Incorrect password.';
      document.getElementById('auth-input').value = '';
      document.getElementById('auth-input').focus();
    }
  }
  document.getElementById('auth-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') checkAuth();
  });
  if (sessionStorage.getItem('babipoly_auth') !== '1') {
    document.getElementById('auth-overlay').classList.remove('hidden');
    document.getElementById('auth-input').focus();
  } else {
    document.getElementById('auth-overlay').classList.add('hidden');
  }
</script>

<!-- ── LOADING OVERLAY ── -->
<div id="loading-overlay">
  <div style="color:#fff;font-size:20px;font-weight:800;letter-spacing:1px;">BABIPOLY</div>
  <div style="color:rgba(255,255,255,0.55);font-size:13px;">Connecting to database...</div>
  <div class="spinner"></div>
</div>

<header>
  <div class="header-top">
    <div class="header-brand">
      <div class="brand-icon"><img src="rfq/logo.jpg" alt="Babipoly logo"></div>
      <div class="brand-text">
        <h1>BABIPOLY</h1>
        <p>Supply Chain Tracker &mdash; Production</p>
      </div>
    </div>
    <div class="header-stats">
      <div class="stat-pill">
        <div class="val" id="hdr-pct">0%</div>
        <div class="lbl">Overall Progress</div>
      </div>
      <div class="stat-pill">
        <div class="val" id="hdr-tasks">0/0</div>
        <div class="lbl">Tasks Completed</div>
      </div>
      <div class="stat-pill">
        <div class="val" id="hdr-comps">0/8</div>
        <div class="lbl">Active Components</div>
      </div>
      <div id="sync-status">
        <div id="sync-dot"></div>
        <span id="sync-label">Online</span>
      </div>
    </div>
  </div>
  <div class="header-progress">
    <div class="progress-bar-row">
      <span class="progress-label">Total Project Progress</span>
      <div class="progress-track">
        <div class="progress-fill" id="global-bar" style="width:0%"></div>
      </div>
      <span class="progress-pct" id="global-pct">0%</span>
    </div>
  </div>
</header>

<nav class="tabs" id="main-tabs">
  <button class="active" data-tab="overview">&#128202; Overview</button>
  <button data-tab="components">&#9881;&#65039; Components</button>
  <button data-tab="suppliers">&#127981; Suppliers</button>
  <button data-tab="timeline">&#128197; Timeline</button>
  <a href="cards/ownership_cards.html">&#127183; Cards</a>
  <a href="cards/chance_community_cards.html">&#127922; Chance &amp; Vie</a>
  <a href="billets/index.html">&#128181; Billets</a>
  <a href="guide/guide.html">&#128214; Guide</a>
  <button data-tab="simulation">&#128202; Simulation</button>
</nav>

<main>

  <!-- ══ TAB: OVERVIEW ══ -->
  <section class="tab-section active" id="tab-overview">
    <div class="stats-row" id="stats-row">
      <div class="stat-card s-total"><div class="num">8</div><div class="txt">Total Components</div></div>
      <div class="stat-card s-active"><div class="num" id="stat-active">0</div><div class="txt">In Progress</div></div>
      <div class="stat-card s-done"><div class="num" id="stat-done">0</div><div class="txt">Completed</div></div>
      <div class="stat-card s-tasks"><div class="num" id="stat-tasks">0%</div><div class="txt">Tasks Validated</div></div>
    </div>

    <div class="section-title">&#127775; Component Status</div>
    <div class="overview-grid" id="overview-grid"></div>
  </section>

  <!-- ══ TAB: COMPONENTS ══ -->
  <section class="tab-section" id="tab-components">
    <div class="section-title">&#9881;&#65039; Components &amp; Production Tasks</div>
    <div class="comp-accordion" id="comp-accordion"></div>
  </section>

  <!-- ══ TAB: SUPPLIERS ══ -->
  <section class="tab-section" id="tab-suppliers">
    <div class="section-title">&#127981; Supplier Directory (China)</div>
    <div class="supplier-dir-grid" id="supplier-dir"></div>
  </section>

  <!-- ══ TAB: TIMELINE ══ -->
  <section class="tab-section" id="tab-timeline">
    <div class="section-title">&#128197; Dashboard &mdash; Progress by Stage</div>
    <div class="timeline-table-wrap">
      <table class="timeline-table" id="timeline-table">
        <thead>
          <tr>
            <th style="width:200px">Component</th>
            <th class="th-design">Design</th>
            <th class="th-rfq">RFQ &amp; Quotes</th>
            <th class="th-sample">Prototype</th>
            <th class="th-prod">Production</th>
            <th class="th-qc">QC Inspection</th>
            <th class="th-ship">Shipping</th>
          </tr>
        </thead>
        <tbody id="timeline-body"></tbody>
      </table>
    </div>
    <p class="text-muted mt-16">
      <span class="tl-cell tl-done">&check; Completed</span>&nbsp;
      <span class="tl-cell tl-active">&#9654; In Progress</span>&nbsp;
      <span class="tl-cell tl-todo">&ndash; To Do</span>
    </p>
  </section>


  <!-- ══ TAB: SIMULATION ══ -->
  <section class="tab-section" id="tab-simulation">

    <!-- ─ Block 1: Key Findings ─ -->
    <div class="sim-block">
      <div class="sim-section-hd">
        <div class="sim-section-num">1</div>
        <div class="sim-section-title">Key Findings from Simulation</div>
      </div>
      <div class="sim-block-body">

        <div class="sim-sub-title">Game Completion Rate &mdash; current rules, 250,000 FCFA start</div>
        <table class="sim-complete-tbl">
          <thead><tr><th>Players</th><th>Completion Rate</th><th>Median (finished)</th><th>Status</th></tr></thead>
          <tbody>
            <tr>
              <td><strong>2 players</strong></td>
              <td><div class="bar-w"><div class="bar-t"><div class="bar-f bg-good" style="width:72%"></div></div><span class="bv good">72%</span></div></td>
              <td>~106 rounds</td>
              <td><span class="sim-pill green">Acceptable</span></td>
            </tr>
            <tr>
              <td><strong>4 players</strong></td>
              <td><div class="bar-w"><div class="bar-t"><div class="bar-f bg-warn" style="width:25%"></div></div><span class="bv warn">25%</span></div></td>
              <td>~368 rounds</td>
              <td><span class="sim-pill amber">Mostly timeout</span></td>
            </tr>
            <tr>
              <td><strong>6 players</strong></td>
              <td><div class="bar-w"><div class="bar-t"><div class="bar-f bg-bad" style="width:12%"></div></div><span class="bv bad">12%</span></div></td>
              <td>~735 rounds</td>
              <td><span class="sim-pill red">Games never end</span></td>
            </tr>
            <tr>
              <td><strong>8 players</strong></td>
              <td><div class="bar-w"><div class="bar-t"><div class="bar-f bg-bad" style="width:12%"></div></div><span class="bv bad">12%</span></div></td>
              <td>~602 rounds</td>
              <td><span class="sim-pill red">Games never end</span></td>
            </tr>
          </tbody>
        </table>
        <div class="sim-note warn" style="margin-top:12px"><strong>Target:</strong> &ge;80% of games should finish naturally within 60&ndash;150 rounds. Only 2-player games meet this today.</div>

        <div class="sim-sub-title" style="margin-top:20px">Root Cause &mdash; Bank injects more than rent extracts</div>
        <p style="font-size:0.85rem;color:#555;margin-bottom:8px">In a typical 4-player game the bank pumps money via GO at a rate that exceeds all rent collected combined, keeping every player solvent indefinitely.</p>
        <div class="sim-flow">
          <div class="sim-flow-box bank">
            <div class="fl">GO Rewards (bank &rarr; players)</div>
            <div class="fv">~60M FCFA</div>
            <div class="fs">per game &mdash; bank injection</div>
          </div>
          <div class="sim-flow-sep">vs</div>
          <div class="sim-flow-box rent">
            <div class="fl">Total Rent (player &rarr; player)</div>
            <div class="fv">~44M FCFA</div>
            <div class="fs">per game &mdash; redistribution</div>
          </div>
          <div class="sim-flow-sep">=</div>
          <div class="sim-flow-box danger">
            <div class="fl">Net surplus per game</div>
            <div class="fv">+16M FCFA</div>
            <div class="fs">bank keeps players liquid</div>
          </div>
        </div>
        <div class="sim-note error" style="margin-top:10px"><strong>Core problem:</strong> Max possible rent (58,000 FCFA &mdash; Grand Bassam hotel) is only <strong>23%</strong> of starting money. Classic Monopoly equivalent is <strong>133%</strong>. A single bad landing cannot endanger a player.</div>

        <div class="sim-sub-title" style="margin-top:20px">Quick Stats</div>
        <div class="sim-stat-grid">
          <div class="sim-stat-card amber"><div class="sv">23%</div><div class="sl">Max rent / starting money</div></div>
          <div class="sim-stat-card red"><div class="sv">4.0%</div><div class="sl">GO reward / starting money</div></div>
          <div class="sim-stat-card red"><div class="sv">75%</div><div class="sl">4P games that time out</div></div>
          <div class="sim-stat-card green"><div class="sv">72%</div><div class="sl">2P completion rate</div></div>
        </div>
      </div>
    </div>

    <!-- ─ Block 2: ROI ─ -->
    <div class="sim-block">
      <div class="sim-section-hd">
        <div class="sim-section-num">2</div>
        <div class="sim-section-title">Property Group ROI Analysis</div>
      </div>
      <div class="sim-block-body">
        <p style="font-size:0.84rem;color:#555;margin-bottom:12px">ROI = avg hotel rent &divide; (avg price + 5 &times; house cost). Higher = group pays back faster. Groups with structural anomalies are flagged.</p>
        <table class="sim-roi-tbl">
          <thead><tr><th>Group</th><th>Props</th><th>Avg Price</th><th>House Cost</th><th>Avg Hotel Rent</th><th>ROI</th><th>Issue</th></tr></thead>
          <tbody>
            <tr><td><span class="gdot" style="background:#F5C518"></span><strong>Yellow</strong></td><td>2</td><td>3,000</td><td>1,000</td><td>10,000</td><td><div class="roi-bw"><div class="roi-bt"><div class="roi-bf" style="width:100%;background:#66bb6a"></div></div><span>125%</span></div></td><td class="sim-flag">Hotel = GO reward</td></tr>
            <tr><td><span class="gdot" style="background:#CC0000"></span><strong>Red</strong></td><td>3</td><td>5,333</td><td>2,000</td><td>16,000</td><td><div class="roi-bw"><div class="roi-bt"><div class="roi-bf" style="width:100%;background:#66bb6a"></div></div><span>104%</span></div></td><td style="color:#aaa">&mdash;</td></tr>
            <tr><td><span class="gdot" style="background:#F7941D"></span><strong>Orange</strong></td><td>3</td><td>6,667</td><td>3,000</td><td>22,667</td><td><div class="roi-bw"><div class="roi-bt"><div class="roi-bf" style="width:100%;background:#66bb6a"></div></div><span>105%</span></div></td><td style="color:#aaa">&mdash;</td></tr>
            <tr><td><span class="gdot" style="background:#8B4513"></span><strong>Brown</strong></td><td>2</td><td>9,500</td><td>4,000</td><td>29,500</td><td><div class="roi-bw"><div class="roi-bt"><div class="roi-bf" style="width:100%;background:#66bb6a"></div></div><span>100%</span></div></td><td style="color:#aaa">&mdash;</td></tr>
            <tr><td><span class="gdot" style="background:#00A651"></span><strong>Green</strong></td><td>3</td><td>11,333</td><td>5,000</td><td>34,000</td><td><div class="roi-bw"><div class="roi-bt"><div class="roi-bf" style="width:93%;background:#66bb6a"></div></div><span>94%</span></div></td><td style="color:#aaa">&mdash;</td></tr>
            <tr><td><span class="gdot" style="background:#29ABE2"></span><strong>Light Blue</strong></td><td>3</td><td>13,333</td><td>6,000</td><td>40,333</td><td><div class="roi-bw"><div class="roi-bt"><div class="roi-bf" style="width:93%;background:#66bb6a"></div></div><span>93%</span></div></td><td style="color:#aaa">&mdash;</td></tr>
            <tr style="background:#fff8f8"><td><span class="gdot" style="background:#1B1464"></span><strong>Dark Blue</strong></td><td>3</td><td>12,000</td><td>7,000</td><td>36,000</td><td><div class="roi-bw"><div class="roi-bt"><div class="roi-bf" style="width:77%;background:#ffa726"></div></div><span>77%</span></div></td><td class="sim-flag">Yamoussoukro anomaly</td></tr>
            <tr><td><span class="gdot" style="background:#662D91"></span><strong>Purple</strong></td><td>2</td><td>18,750</td><td>10,000</td><td>54,000</td><td><div class="roi-bw"><div class="roi-bt"><div class="roi-bf" style="width:79%;background:#ffa726"></div></div><span>79%</span></div></td><td style="color:#aaa">&mdash;</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ─ Block 3: Fixes ─ -->
    <div class="sim-block">
      <div class="sim-section-hd">
        <div class="sim-section-num">3</div>
        <div class="sim-section-title">Proposed Fixes &mdash; Priority Order</div>
      </div>
      <div class="sim-block-body">

        <div class="sim-fix-card">
          <div class="sim-fix-hd"><span class="sim-fix-title">Fix 1 &mdash; Reduce GO Reward</span><span class="sim-pri p1">Priority 1 &mdash; Critical</span></div>
          <div class="sim-fix-body">
            <p style="font-size:0.84rem;color:#444">GO reward is the primary driver of infinite games. Every round the bank injects 10,000 FCFA per player, collectively outpacing all rent income. Cutting it in half immediately reduces bank-side money supply.</p>
            <div class="sim-ba">
              <div class="sim-ba-box before"><div class="bl">Current</div><div class="bv2">10,000 FCFA</div></div>
              <div class="sim-ba-arrow">&#8594;</div>
              <div class="sim-ba-box after"><div class="bl">Proposed</div><div class="bv2">5,000 FCFA</div></div>
            </div>
            <div class="sim-impact">Impact: reduces bank injection from ~60M &rarr; ~30M FCFA per 4P game</div>
          </div>
        </div>

        <div class="sim-fix-card">
          <div class="sim-fix-hd"><span class="sim-fix-title">Fix 2 &mdash; Yamoussoukro Anomaly (pos 31, Dark Blue)</span><span class="sim-pri p1">Priority 1 &mdash; Critical</span></div>
          <div class="sim-fix-body">
            <p style="font-size:0.84rem;color:#444">Yamoussoukro's house cost (7,000 FCFA) <em>exceeds</em> its purchase price (5,000 FCFA). A full hotel development costs 35,000 FCFA but yields only 19,000 FCFA rent &mdash; negative ROI. Nobody will ever develop this property, making Dark Blue partially unplayable.</p>
            <div class="sim-ba">
              <div class="sim-ba-box before"><div class="bl">House cost (current)</div><div class="bv2">7,000 FCFA</div></div>
              <div class="sim-ba-arrow">&#8594;</div>
              <div class="sim-ba-box after"><div class="bl">House cost (proposed)</div><div class="bv2">4,000 FCFA</div></div>
            </div>
            <p style="font-size:0.78rem;color:#888;margin-top:8px;font-style:italic">Alternative: raise Yamoussoukro price 5,000 &rarr; 12,000 FCFA to match peers (Sassandra 15k, San Pedro 16k).</p>
            <div class="sim-impact">Impact: Dark Blue group becomes developable and competitive</div>
          </div>
        </div>

        <div class="sim-fix-card">
          <div class="sim-fix-hd"><span class="sim-fix-title">Fix 3 &mdash; Reduce Starting Money</span><span class="sim-pri p2">Priority 2 &mdash; High</span></div>
          <div class="sim-fix-body">
            <p style="font-size:0.84rem;color:#444">With 250,000 FCFA, even the most expensive hotel (58,000 FCFA) leaves 192,000 FCFA &mdash; far from bankruptcy. Reducing starting money makes each rent proportionally more dangerous. <strong>Must be combined with Fix 1 for full effect.</strong></p>
            <div class="sim-ba">
              <div class="sim-ba-box before"><div class="bl">Current</div><div class="bv2">250,000 FCFA</div></div>
              <div class="sim-ba-arrow">&#8594;</div>
              <div class="sim-ba-box after"><div class="bl">Proposed</div><div class="bv2">60,000 FCFA</div></div>
            </div>
            <div class="sim-note info" style="margin-top:10px">Starting money alone does not fix infinite games. Even at 20,000 FCFA, 4P games only complete 46% of the time because GO rewards keep refilling wallets. Fix 1 must accompany this.</div>
          </div>
        </div>

        <div class="sim-fix-card">
          <div class="sim-fix-hd"><span class="sim-fix-title">Fix 4 &mdash; Raise Yellow Group Rents</span><span class="sim-pri p3">Priority 3 &mdash; Medium</span></div>
          <div class="sim-fix-body">
            <p style="font-size:0.84rem;color:#444">Yellow hotel rent (10,000 FCFA) equals the GO reward. Landing on a fully-developed Yellow group is no worse than passing GO &mdash; it has zero threat as the first color group on the board.</p>
            <div class="sim-ba">
              <div class="sim-ba-box before"><div class="bl">Hotel rent (current)</div><div class="bv2">10,000 FCFA</div></div>
              <div class="sim-ba-arrow">&#8594;</div>
              <div class="sim-ba-box after"><div class="bl">Hotel rent (proposed)</div><div class="bv2">18,000 FCFA</div></div>
            </div>
            <div class="sim-impact">Impact: Yellow monopoly becomes a real early-game threat</div>
          </div>
        </div>

        <div class="sim-fix-card">
          <div class="sim-fix-hd"><span class="sim-fix-title">Fix 5 &mdash; Increase Taxe Choco</span><span class="sim-pri p4">Priority 4 &mdash; Nice to Have</span></div>
          <div class="sim-fix-body">
            <p style="font-size:0.84rem;color:#444">Taxe Choco (pos 38) charges 5,000 FCFA &mdash; half of one GO reward. Raising it adds a meaningful drain that scales with higher starting money scenarios.</p>
            <div class="sim-ba">
              <div class="sim-ba-box before"><div class="bl">Current tax</div><div class="bv2">5,000 FCFA</div></div>
              <div class="sim-ba-arrow">&#8594;</div>
              <div class="sim-ba-box after"><div class="bl">Proposed tax</div><div class="bv2">8,000 FCFA</div></div>
            </div>
            <div class="sim-impact">Impact: minor drain reducing excess mid-game cash</div>
          </div>
        </div>

      </div>
    </div>

    <!-- ─ Block 4: Parameter Table ─ -->
    <div class="sim-block">
      <div class="sim-section-hd">
        <div class="sim-section-num">4</div>
        <div class="sim-section-title">Complete Parameter Comparison</div>
      </div>
      <div class="sim-block-body">
        <table class="sim-cmp-tbl">
          <thead>
            <tr>
              <th style="text-align:left">Parameter</th>
              <th class="col-c">Current Rules</th>
              <th class="col-a">Option A<br><small>(minimal)</small></th>
              <th class="col-r">Option C<br><small>(recommended)</small></th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Starting money</td><td class="col-c">250,000 FCFA</td><td class="col-a">40,000 FCFA</td><td class="col-r">60,000 FCFA</td></tr>
            <tr><td>GO reward</td><td class="col-c">10,000 FCFA</td><td class="col-a">4,000 FCFA</td><td class="col-r">5,000 FCFA</td></tr>
            <tr><td>Rent multiplier</td><td class="col-c">1&times;</td><td class="col-a">1&times;</td><td class="col-r">1.5&times;</td></tr>
            <tr><td>Jail bail</td><td class="col-c">5,000 FCFA</td><td class="col-a">1,000 FCFA</td><td class="col-r">1,500 FCFA</td></tr>
            <tr><td>Yellow hotel rent</td><td class="col-c">10,000 FCFA</td><td class="unch">unchanged</td><td class="col-r">18,000 FCFA</td></tr>
            <tr><td>Yamoussoukro house cost</td><td class="col-c">7,000 FCFA</td><td class="unch">unchanged</td><td class="col-r">4,000 FCFA</td></tr>
            <tr><td>Dark Blue house cost</td><td class="col-c">7,000 FCFA</td><td class="unch">unchanged</td><td class="col-r">5,000 FCFA</td></tr>
            <tr><td>Taxe Choco</td><td class="col-c">5,000 FCFA</td><td class="col-a">1,000 FCFA</td><td class="col-r">8,000 FCFA</td></tr>
            <tr><td>Utility rent (1 owned)</td><td class="col-c">4&times; dice</td><td class="unch">unchanged</td><td class="col-r">2,000 FCFA flat</td></tr>
            <tr><td>Utility rent (2 owned)</td><td class="col-c">10&times; dice</td><td class="unch">unchanged</td><td class="col-r">8,000 FCFA flat</td></tr>
          </tbody>
        </table>
        <div class="sim-note good" style="margin-top:14px"><strong>Option C rationale:</strong> The 1.5&times; rent multiplier means all existing printed rent values increase proportionally. Flat utility rents replace the dice-multiplier which currently produces negligible amounts (avg 28&ndash;70 FCFA per landing). Full proposal: <a href="simulation/balance_proposals.html" style="color:var(--accent)">simulation/balance_proposals.html</a></div>
      </div>
    </div>

    <!-- ─ Block 5: How to Test ─ -->
    <div class="sim-block">
      <div class="sim-section-hd">
        <div class="sim-section-num">5</div>
        <div class="sim-section-title">How to Test These Changes</div>
      </div>
      <div class="sim-block-body">
        <ul class="sim-steps">
          <li><div class="sim-step-num">1</div><div><div class="sim-step-title">Edit constants in babipoly_sim.py</div><div class="sim-step-desc">Change <code>STARTING_MONEY</code> and <code>GO_REWARD</code> at the top of the file. For rent multiplier, multiply each value in the rent arrays.</div></div></li>
          <li><div class="sim-step-num">2</div><div><div class="sim-step-title">Run the main simulator</div><div class="sim-step-desc"><code>python simulation/babipoly_sim.py --games 500 --seed 42</code><br>Target: &ge;80% completion rate, median 60&ndash;150 rounds.</div></div></li>
          <li><div class="sim-step-num">3</div><div><div class="sim-step-title">Run the multi-scenario analysis</div><div class="sim-step-desc"><code>python simulation/run_analysis.py --games 200</code><br>Compares 5 starting-money configurations and ranks the best for each player count.</div></div></li>
          <li><div class="sim-step-num">4</div><div><div class="sim-step-title">Check first-player bias</div><div class="sim-step-desc">Win rate by player order is shown in the output. First player should win within &plusmn;5% of expected (50% for 2P, 25% for 4P, etc.).</div></div></li>
          <li><div class="sim-step-num">5</div><div><div class="sim-step-title">View full balance proposals</div><div class="sim-step-desc">Open <a href="simulation/balance_proposals.html" style="color:var(--accent)">simulation/balance_proposals.html</a> for a printable detailed report.</div></div></li>
        </ul>
      </div>
    </div>

  </section>

</main>

<script>
// ═══════════════════════════════════════════════════════════════════════════
//  DATA
// ═══════════════════════════════════════════════════════════════════════════

const STAGES = [
  { id: 'design',     label: 'Design',       icon: '✏️', color: '#8e44ad' },
  { id: 'rfq',        label: 'RFQ & Quotes', icon: '📋', color: '#2980b9' },
  { id: 'sample',     label: 'Prototype',    icon: '🔬', color: '#d35400' },
  { id: 'production', label: 'Production',   icon: '🏭', color: '#16a085' },
  { id: 'qc',         label: 'QC Inspection',icon: '✅', color: '#c0392b' },
  { id: 'shipping',   label: 'Shipping',     icon: '🚢', color: '#27ae60' },
];

const COMPONENTS = [
  {
    id: 'board',
    name: 'Game Board',
    nameEn: 'Game Board',
    icon: '🗺️',
    specs: '500×500mm open — 4-fold design (cross) — 2mm greyboard — matte laminate',
    category: 'print',
    suppliers: [
      {
        name: 'Dongguan Shenghua Printing Co., Ltd',
        city: 'Dongguan, Guangdong',
        specialty: 'Board game specialist, offset printing',
        contact: 'sales@shenghuaprinting.com',
        moq: '500 units',
      },
      {
        name: 'Guangzhou Raynna Paper Products Co., Ltd',
        city: 'Guangzhou, Guangdong',
        specialty: 'Custom board games & packaging',
        contact: 'info@raynnaprinting.com',
        moq: '300 units',
      },
      {
        name: 'Yancheng Wanlida Toy & Gift Co., Ltd',
        city: 'Yancheng, Jiangsu',
        specialty: 'Complete board game manufacturing',
        contact: 'wanlida@wanlida.cn',
        moq: '500 units',
      },
      {
        name: 'PICA — Imprimerie du Plateau',
        city: 'Yopougon, Abidjan',
        specialty: 'Offset industriel, pelliculage, rembordage carton',
        contact: '(+225) 27 23 46 75 64',
        moq: 'Sur devis',
        website: 'http://www.pica-abidjan.net/',
      },
      {
        name: 'Graphicolor SA',
        city: 'Treichville, Abidjan',
        specialty: 'Offset 4-6 couleurs, vernis, brochures, packaging',
        contact: 'info@graphicolor-ci.com',
        moq: 'Sur devis',
        website: 'https://graphicolor-ci.com/',
      },
    ],
    stages: [
      {
        id: 'design',
        tasks: [
          'Finalize 500×500mm game board graphic design',
          'Prepare high-resolution PDF print files (CMYK, 300dpi)',
          'Validate 4-fold zones (cross structure)',
          'Send files for color proof',
          'Final design approval — sign off',
        ],
      },
      {
        id: 'rfq',
        tasks: [
          'Send RFQ with full specs to 3+ printers',
          'Receive and compare quotes (FOB price, lead times)',
          'Negotiate price and payment terms',
          'Select final supplier',
          'Sign purchase order (PO)',
        ],
      },
      {
        id: 'sample',
        tasks: [
          'Order a pre-production print sample',
          'Receive physical prototype',
          'Test fold durability (no cracking)',
          'Check print quality and matte lamination',
          'Approve prototype (or request corrections)',
        ],
      },
      {
        id: 'production',
        tasks: [
          'Pay production deposit (30-50%)',
          'Confirm production launch',
          'Receive mid-production progress report',
          'Production complete — receive factory notification',
        ],
      },
      {
        id: 'qc',
        tasks: [
          'Commission third-party QC inspection (e.g. QIMA, Bureau Veritas)',
          'Receive and analyze inspection report',
          'Verify: no cracks at board folds',
          'Verify: no lamination bubbles',
          'Approve shipment',
        ],
      },
      {
        id: 'shipping',
        tasks: [
          'Book freight forwarder / shipping agent',
          'Receive commercial invoice and packing list',
          'Confirm goods loading',
          'Track shipment (tracking number)',
          'Confirm delivery to destination warehouse',
        ],
      },
    ],
  },

  {
    id: 'cards',
    name: 'Playing Cards',
    nameEn: 'Playing Cards',
    icon: '🃏',
    specs: '60 cards (16 Chance + 16 Community Chest + 28 Property) — 63×88mm — 300gsm black core',
    category: 'print',
    suppliers: [
      {
        name: 'Wuhu Xinqi Printing & Packaging Co., Ltd',
        city: 'Wuhu, Anhui',
        specialty: 'Playing card specialist, black core, matte/glossy finish',
        contact: 'xinqi@xinqiprint.com',
        moq: '1000 sets',
      },
      {
        name: 'Shenzhen Goldensun Game & Gift Co., Ltd',
        city: 'Shenzhen, Guangdong',
        specialty: 'Custom playing cards & complete board games',
        contact: 'info@goldensungame.com',
        moq: '500 sets',
        website: 'https://goldsunprinting.com/',
      },
      {
        name: 'Hangzhou Heyuan Card Industry Co., Ltd',
        city: 'Hangzhou, Zhejiang',
        specialty: 'Large format & standard playing cards, black core',
        contact: 'sales@heyuancard.com',
        moq: '1000 sets',
      },
      {
        name: 'Hooda Graphics Imprimerie',
        city: 'Cocody, Abidjan',
        specialty: 'Offset jusqu\'à 400g/m², impression couleur, cartes',
        contact: 'info@hoodagraphics.com',
        moq: 'Sur devis',
        website: 'https://www.hoodagraphics.com/',
      },
      {
        name: 'Graphicolor SA',
        city: 'Treichville, Abidjan',
        specialty: 'Offset 4-6 couleurs, vernis, impression cartes',
        contact: 'info@graphicolor-ci.com',
        moq: 'Sur devis',
        website: 'https://graphicolor-ci.com/',
      },
    ],
    stages: [
      {
        id: 'design',
        tasks: [
          'Finalize artwork for all 3 card types (16 Chance + 16 Community + 28 Property)',
          'Prepare 63×88mm double-sided files with bleed (3mm bleed)',
          'Validate all French text on cards',
          'Send for color proof',
          'Final design approval',
        ],
      },
      {
        id: 'rfq',
        tasks: [
          'Send RFQ: 60 cards, 300gsm black core, matte finish, square corners',
          'Specify: double-sided CMYK printing',
          'Receive at least 3 quotes',
          'Verify "black core" spec (full opacity)',
          'Select supplier and send PO',
        ],
      },
      {
        id: 'sample',
        tasks: [
          'Order 1 complete sample set (60 cards)',
          'Check cut quality and square corners',
          'Test black core opacity (no transparency)',
          'Check matte finish and print quality',
          'Approve samples',
        ],
      },
      {
        id: 'production',
        tasks: [
          'Pay production deposit',
          'Launch production (60 cards × ordered quantity)',
          'Production follow-up — factory report',
          'Production complete — confirmed by factory',
        ],
      },
      {
        id: 'qc',
        tasks: [
          'Inspection: check clean cut and alignment',
          'Check black core opacity on each card type',
          'Count exact quantities (16+16+28 per set)',
          'Check uniform matte finish',
          'Approve shipment',
        ],
      },
      {
        id: 'shipping',
        tasks: [
          'Group shipment with other printed components',
          'Book freight forwarder',
          'Shipping documents ready',
          'Confirm loading',
          'Confirm delivery to warehouse',
        ],
      },
    ],
  },

  {
    id: 'money',
    name: 'Paper Money',
    nameEn: 'Paper Money',
    icon: '💵',
    specs: '240 bills — 4 denominations (1000F / 2000F / 5000F / 10000F) — 155×65mm — 80gsm offset',
    category: 'print',
    suppliers: [
      {
        name: 'Shenzhen Jinhao Printing Co., Ltd',
        city: 'Shenzhen, Guangdong',
        specialty: 'Specialized printing for game money & accessories',
        contact: 'sales@jinhaoprint.com',
        moq: '500 sets',
        website: 'https://www.jinhaoprint.com/',
      },
      {
        name: 'Guangzhou Meijie Printing Co., Ltd',
        city: 'Guangzhou, Guangdong',
        specialty: 'Offset printing on colored paper, game bills',
        contact: 'meijie@meijieprint.com',
        moq: '1000 sets',
      },
      {
        name: 'Yiwu Xishu Paper Products Co., Ltd',
        city: 'Yiwu, Zhejiang',
        specialty: 'Board game money specialist',
        contact: 'xishu@xishupp.com',
        moq: '500 sets',
      },
      {
        name: 'Graphicolor SA',
        city: 'Treichville, Abidjan',
        specialty: 'Offset 4-6 couleurs, impression billets de jeu',
        contact: 'info@graphicolor-ci.com',
        moq: 'Sur devis',
        website: 'https://graphicolor-ci.com/',
      },
      {
        name: 'PICA — Imprimerie du Plateau',
        city: 'Yopougon, Abidjan',
        specialty: 'Offset industriel, impression papier coloré',
        contact: '(+225) 27 23 46 75 64',
        moq: 'Sur devis',
        website: 'http://www.pica-abidjan.net/',
      },
    ],
    stages: [
      {
        id: 'design',
        tasks: [
          'Finalize artwork for 4 denominations (1000F, 2000F, 5000F, 10000F)',
          'Format 155×65mm — single-sided print on colored paper',
          'Validate amounts, text and graphic elements',
          'Choose background colors for each denomination',
          'Final bill approval',
        ],
      },
      {
        id: 'rfq',
        tasks: [
          'Send RFQ: 240 bills, 4 denominations, 60 of each',
          'Specify 80gsm offset paper, colored background per denomination',
          'Request quotes for the 4 paper colors',
          'Receive at least 3 quotes',
          'Select supplier and send PO',
        ],
      },
      {
        id: 'sample',
        tasks: [
          'Order a sample of all 4 denominations',
          'Check background paper color for each denomination',
          'Verify readability of values and text',
          'Check cut quality (155×65mm)',
          'Approve samples',
        ],
      },
      {
        id: 'production',
        tasks: [
          'Pay deposit',
          'Launch production: 240 bills × ordered quantity',
          'Confirm denomination split (60×4)',
          'Production complete — confirmed',
        ],
      },
      {
        id: 'qc',
        tasks: [
          'Verify exact quantities per denomination (60 × 4)',
          'Check print quality and background colors',
          'Verify dimensions 155×65mm',
          'Approve shipment',
        ],
      },
      {
        id: 'shipping',
        tasks: [
          'Group with other printed components',
          'Shipping documents ready',
          'Confirm loading',
          'Confirm delivery to warehouse',
        ],
      },
    ],
  },

  {
    id: 'pieces',
    name: 'Houses & Hotels',
    nameEn: 'Houses & Hotels',
    icon: '🏠',
    specs: '30 green houses + 15 red hotels — ABS plastic — injection molded',
    category: 'plastic',
    suppliers: [
      {
        name: 'Dongguan Yisheng Plastic Products Co., Ltd',
        city: 'Dongguan, Guangdong',
        specialty: 'Injection molded ABS parts, board game accessories',
        contact: 'sales@yishengplastic.com',
        moq: '5000 pcs',
      },
      {
        name: 'Shenzhen Junye Plastic Industrial Co., Ltd',
        city: 'Shenzhen, Guangdong',
        specialty: 'Small colored plastic pieces for games',
        contact: 'junye@junyeplastic.com',
        moq: '3000 pcs',
        website: 'https://www.junye88.com/en',
      },
      {
        name: 'Guangdong Haicheng Plastic Industry Co., Ltd',
        city: 'Foshan, Guangdong',
        specialty: 'Small ABS plastic parts manufacturing',
        contact: 'info@haichengplastic.com',
        moq: '5000 pcs',
      },
      {
        name: 'TAJ PLAST (Coraxel)',
        city: 'Koumassi, Abidjan',
        specialty: 'Injection plastique, 50+ presses, articles enfants',
        contact: 'tajplast@yahoo.fr',
        moq: 'Sur devis',
        website: 'https://tajplast.com/',
      },
      {
        name: 'OK PLAST',
        city: 'Yopougon, Abidjan',
        specialty: 'Injection plastique, 150+ machines, ISO 9001',
        contact: 'r.reda@okplast-ci.com',
        moq: 'Sur devis',
        website: 'https://okplast-ci.com/',
      },
    ],
    stages: [
      {
        id: 'design',
        tasks: [
          'Validate dimensions (standard Monopoly equivalent)',
          'Confirm that hotels are larger than houses',
          'Check if an existing standard mold can be used',
          'Finalize color spec (green / bright red)',
        ],
      },
      {
        id: 'rfq',
        tasks: [
          'Send RFQ: 30 green houses + 15 red hotels, ABS, injection molded',
          'Ask if existing mold is available (saves cost)',
          'Receive quotes with and without mold cost',
          'Select plastic parts supplier',
          'Send PO with precise color specifications',
        ],
      },
      {
        id: 'sample',
        tasks: [
          'Order house and hotel samples',
          'Check dimensions and ABS durability',
          'Test piece stability on the game board',
          'Check colors (green / red)',
          'Approve or request corrections',
        ],
      },
      {
        id: 'production',
        tasks: [
          'Pay production deposit',
          'Launch injection molding production',
          'Confirm: 30 houses × Q + 15 hotels × Q per batch',
          'Production complete — confirmed',
        ],
      },
      {
        id: 'qc',
        tasks: [
          'Check for injection flash/burrs',
          'Verify color compliance (green / red)',
          'Count quantities (30 houses + 15 hotels per set)',
          'Check piece durability (no breakage)',
          'Approve shipment',
        ],
      },
      {
        id: 'shipping',
        tasks: [
          'Book freight forwarder (can be combined with tokens)',
          'Shipping documents ready',
          'Confirm loading',
          'Confirm delivery to warehouse',
        ],
      },
    ],
  },

  {
    id: 'tokens',
    name: 'Player Tokens',
    nameEn: 'Player Tokens',
    icon: '🐘',
    specs: '8 elephant tokens ABS — 20-25mm height — 8 colors — custom mold (Babipoly property)',
    category: 'plastic',
    suppliers: [
      {
        name: 'Dongguan Zhonghe Model Co., Ltd',
        city: 'Dongguan, Guangdong',
        specialty: 'Custom molds & plastic figurines for games',
        contact: 'sales@zhonghemold.com',
        moq: 'Mold + 1000 sets',
      },
      {
        name: 'Shenzhen Weilian Plastic Technology Co., Ltd',
        city: 'Shenzhen, Guangdong',
        specialty: 'Custom ABS mold design and manufacturing',
        contact: 'weilian@weilianplastic.com',
        moq: 'Mold + 500 sets',
      },
      {
        name: 'Guangzhou Kaka Toys Co., Ltd',
        city: 'Guangzhou, Guangdong',
        specialty: 'Custom game figurines and tokens',
        contact: 'kaka@kakatoys.com',
        moq: '1000 sets',
        website: 'http://www.kakatoys.com/',
      },
      {
        name: 'Groupe SIMPA',
        city: 'Abidjan',
        specialty: 'Injection plastique, articles promotionnels, figurines',
        contact: 'commercial@simpaci.com',
        moq: 'Sur devis',
        website: 'https://www.groupesimpa.com/',
      },
      {
        name: 'IMP SARL + TAJ PLAST',
        city: 'Koumassi, Abidjan',
        specialty: 'Fabrication moules + injection figurines',
        contact: '(+225) 27 21 51 97 42 / tajplast@yahoo.fr',
        moq: 'Sur devis',
        website: 'https://tajplast.com/',
      },
    ],
    stages: [
      {
        id: 'design',
        tasks: [
          'Finalize 3D design of elephant token (20-25mm height)',
          'Create technical 3D file (STL / STEP) or dimensioned drawing',
          'Validate list of 8 ABS colors',
          'Confirm that the mold will be Babipoly property',
          'Final 3D design approval',
        ],
      },
      {
        id: 'rfq',
        tasks: [
          'Send RFQ with 3D file or technical drawing',
          'Request quote for custom mold + cost per token',
          'Confirm legal mold ownership (contractual clause)',
          'Receive at least 3 quotes',
          'Select mold manufacturer',
          'Sign contract including mold ownership clause',
        ],
      },
      {
        id: 'sample',
        tasks: [
          'Order T1 mold samples (first pass)',
          'Check shape and proportions of elephant token',
          'Test all 8 colors on samples',
          'Request corrections if necessary (T2, T3)',
          'Final mold approval — Green Light for production',
        ],
      },
      {
        id: 'production',
        tasks: [
          'Pay production deposit',
          'Launch injection of 8 colors',
          'Confirm: 8 tokens per set (1 per color)',
          'Production complete — confirmed',
        ],
      },
      {
        id: 'qc',
        tasks: [
          'Check for injection burrs on each token',
          'Verify exact 8 colors',
          'Count quantities per set (8 tokens × Q sets)',
          'Check size (20-25mm)',
          'Approve shipment',
        ],
      },
      {
        id: 'shipping',
        tasks: [
          'Book freight forwarder',
          'Documents with mold declaration (if shipped separately)',
          'Confirm loading',
          'Confirm delivery to warehouse',
        ],
      },
    ],
  },

  {
    id: 'dice',
    name: 'Dice',
    nameEn: 'Dice',
    icon: '🎲',
    specs: '2 dice — 16mm — white acrylic — black pips',
    category: 'accessories',
    suppliers: [
      {
        name: 'Dongguan Kaika Acrylic Products Co., Ltd',
        city: 'Dongguan, Guangdong',
        specialty: 'Standard and custom acrylic dice',
        contact: 'kaika@kaikaacrylic.com',
        moq: '10,000 dice',
      },
      {
        name: 'Ningbo Zhixin Toys Co., Ltd',
        city: 'Ningbo, Zhejiang',
        specialty: 'Board game accessories: dice, chips, pieces',
        contact: 'sales@zhixintoys.com',
        moq: '5,000 dice',
      },
      {
        name: 'Yiwu Diangong Toy Co., Ltd',
        city: 'Yiwu, Zhejiang',
        specialty: 'Dice and game accessories — volume manufacturer',
        contact: 'diangong@diangongtoy.com',
        moq: '5,000 dice',
      },
      {
        name: 'Plasticolle',
        city: 'Treichville, Abidjan',
        specialty: 'Jouets plastiques, petites pièces, accessoires',
        contact: 'superplastci@hotmail.fr',
        moq: 'Sur devis',
      },
    ],
    stages: [
      {
        id: 'design',
        tasks: [
          'Confirm specs: 16mm, acrylic, white with black pips',
          'Validate that no custom design is required (standard)',
          'Confirm quantity: 2 dice per set × Q sets',
        ],
      },
      {
        id: 'rfq',
        tasks: [
          'Send RFQ: 16mm dice, white acrylic, black pips',
          'Ask to bundle with another supplier if possible',
          'Compare quotes (price per unit)',
          'Select supplier',
          'Send PO',
        ],
      },
      {
        id: 'sample',
        tasks: [
          'Order a sample of 16mm acrylic dice',
          'Test dice balance (random roll)',
          'Check sharpness of black pips',
          'Approve samples',
        ],
      },
      {
        id: 'production',
        tasks: [
          'Confirm order (2 dice × Q sets)',
          'Launch production',
          'Production complete — confirmed',
        ],
      },
      {
        id: 'qc',
        tasks: [
          'Check pip clarity (1 to 6)',
          'Check acrylic quality (no bubbles)',
          'Count quantities (2 dice per set)',
          'Approve shipment',
        ],
      },
      {
        id: 'shipping',
        tasks: [
          'Group with other accessory components',
          'Shipping documents ready',
          'Confirm loading',
          'Confirm delivery to warehouse',
        ],
      },
    ],
  },

  {
    id: 'booklet',
    name: 'Instruction Booklet',
    nameEn: 'Instruction Booklet',
    icon: '📖',
    specs: '4-page A5 (148×210mm) — 157gsm art paper — CMYK double-sided — saddle-stitched',
    category: 'print',
    suppliers: [
      {
        name: 'Shenzhen Jinhao Printing Co., Ltd',
        city: 'Shenzhen, Guangdong',
        specialty: 'Brochures, booklets and quality printing',
        contact: 'sales@jinhaoprint.com',
        moq: '500 booklets',
        website: 'https://www.jinhaoprint.com/',
      },
      {
        name: 'Guangzhou Artron Color Printing Co., Ltd',
        city: 'Guangzhou, Guangdong',
        specialty: 'High quality color printing, booklets and brochures',
        contact: 'artron@artronprint.com',
        moq: '1000 booklets',
        website: 'https://www.artronprint.com/',
      },
      {
        name: 'Dongguan Tuosite Printing Co., Ltd',
        city: 'Dongguan, Guangdong',
        specialty: 'Game booklets and presentation brochures',
        contact: 'sales@tuositeprint.com',
        moq: '500 booklets',
      },
      {
        name: 'Hooda Graphics Imprimerie',
        city: 'Cocody, Abidjan',
        specialty: 'Brochures, livrets, impression couleur jusqu\'à 400g/m²',
        contact: 'info@hoodagraphics.com',
        moq: 'Sur devis',
        website: 'https://www.hoodagraphics.com/',
      },
      {
        name: 'Imprimerie Grande Marque (IGM)',
        city: 'Cocody, Abidjan',
        specialty: 'Offset, impression numérique, livrets',
        contact: 'Via site web',
        moq: 'Sur devis',
        website: 'https://imprimeriegrandemarque.com/',
      },
    ],
    stages: [
      {
        id: 'design',
        tasks: [
          'Write complete Babipoly game rules',
          'Layout A5 (148×210mm), 4 pages (2 saddle-stitched sheets)',
          'Integrate illustrations and graphic design',
          'Final proofreading and rule validation by the team',
          'Final booklet approval',
        ],
      },
      {
        id: 'rfq',
        tasks: [
          'Send RFQ: A5 booklet, 4pp, 157gsm art paper, CMYK double-sided',
          'Specify: saddle stitch binding, matte finish',
          'Can be grouped with board supplier',
          'Receive at least 2 quotes',
          'Select supplier — send PO',
        ],
      },
      {
        id: 'sample',
        tasks: [
          'Order a printed booklet sample',
          'Check text readability (font size, contrast)',
          'Check illustration quality',
          'Check saddle-stitch binding (secure)',
          'Approve sample',
        ],
      },
      {
        id: 'production',
        tasks: [
          'Pay deposit',
          'Launch booklet production',
          'Production complete — confirmed',
        ],
      },
      {
        id: 'qc',
        tasks: [
          'Check saddle-stitch binding on a sample',
          'Check readability and color quality',
          'Count quantities',
          'Approve shipment',
        ],
      },
      {
        id: 'shipping',
        tasks: [
          'Group with printed components',
          'Shipping documents ready',
          'Confirm loading',
          'Confirm delivery to warehouse',
        ],
      },
    ],
  },

  {
    id: 'packaging',
    name: 'Game Box',
    nameEn: 'Game Box',
    icon: '📦',
    specs: '270×270×60mm — Rigid telescope box — 2mm greyboard — matte laminate — thermoformed tray',
    category: 'print',
    suppliers: [
      {
        name: 'Shenzhen Yuto Packaging Technology Co., Ltd',
        city: 'Shenzhen, Guangdong',
        specialty: 'Premium rigid boxes, premium packaging',
        contact: 'sales@yutopackaging.com',
        moq: '500 units',
        website: 'https://www.szyuto.com/',
      },
      {
        name: 'Dongguan Xianglee Printing & Packaging Co., Ltd',
        city: 'Dongguan, Guangdong',
        specialty: 'Board game packaging: boxes + thermoformed trays',
        contact: 'xianglee@xiangleepack.com',
        moq: '300 units',
        website: 'https://www.printing-supplier.com/',
      },
      {
        name: 'Shanghai Birdview Packaging Co., Ltd',
        city: 'Shanghai',
        specialty: 'Premium rigid packaging, quality game boxes',
        contact: 'info@birdviewpack.com',
        moq: '500 units',
      },
      {
        name: 'Shuotong Packaging SARL',
        city: 'Abidjan',
        specialty: 'Emballage carton sur mesure, boîtes rigides',
        contact: 'Via site web',
        moq: 'Sur devis',
        website: 'https://www.shuotongpackagingci.com/',
      },
      {
        name: 'PICA — Imprimerie du Plateau',
        city: 'Yopougon, Abidjan',
        specialty: 'Pelliculage, rembordage, boîtes carton imprimées',
        contact: '(+225) 27 23 46 75 64',
        moq: 'Sur devis',
        website: 'http://www.pica-abidjan.net/',
      },
    ],
    stages: [
      {
        id: 'design',
        tasks: [
          'Finalize artwork for box lid and base',
          'Format 270×270×60mm — telescope box (lid & base)',
          'Design thermoformed tray (fitting all components)',
          'Include space for barcode (EAN)',
          'Final packaging design approval',
        ],
      },
      {
        id: 'rfq',
        tasks: [
          'Send RFQ: rigid telescope box 270×270×60mm, 2mm greyboard + 157gsm paper',
          'Specify: matte finish + shrink wrap + EAN barcode space',
          'Request separate quote for thermoformed tray',
          'Receive at least 3 quotes',
          'Select packaging manufacturer — send PO',
        ],
      },
      {
        id: 'sample',
        tasks: [
          'Order a complete box mockup / sample',
          'Check structural strength (2mm greyboard)',
          'Test thermoformed tray with all physical components',
          'Check lid closure (telescope well fitted)',
          'Check matte lamination quality and printing',
          'Approve packaging sample',
        ],
      },
      {
        id: 'production',
        tasks: [
          'Pay deposit',
          'Launch production: boxes + thermoformed trays',
          'Receive mid-production progress report',
          'Production complete — confirmed',
        ],
      },
      {
        id: 'qc',
        tasks: [
          'Check solid structure (no deformation)',
          'Verify: no lamination bubbles',
          'Test complete game assembly in box',
          'Check shrink wrap and presence of EAN space',
          'Approve shipment',
        ],
      },
      {
        id: 'shipping',
        tasks: [
          'Coordinate final assembly (all components in box)',
          'Book freight forwarder for final shipment',
          'Complete shipping documents ready',
          'Confirm loading of complete batch',
          'Confirm delivery to destination warehouse',
        ],
      },
    ],
  },
];

// ═══════════════════════════════════════════════════════════════════════════
//  STATE — persisted in Firebase Realtime Database (see bottom of file)
// ═══════════════════════════════════════════════════════════════════════════

// state shape:
// { board: { tasks: { design_0: true, ... }, supplier: 1 }, ... }
let state = {};

// saveState and the Firebase listener are defined at the bottom of the file
// after the Firebase SDK is loaded. This stub prevents errors during init.
function saveState() {}

function ensureComp(id) {
  if (!state[id]) state[id] = { tasks: {}, supplier: null };
  if (!state[id].tasks) state[id].tasks = {};
}

// ─── TASK KEY ───
function taskKey(stageId, taskIdx) { return `${stageId}_${taskIdx}`; }

function isTaskDone(compId, stageId, taskIdx) {
  ensureComp(compId);
  return !!state[compId].tasks[taskKey(stageId, taskIdx)];
}

function toggleTask(compId, stageId, taskIdx) {
  ensureComp(compId);
  const k = taskKey(stageId, taskIdx);
  state[compId].tasks[k] = !state[compId].tasks[k];
  saveState();
  updateAll();
}

function setSupplier(compId, idx) {
  ensureComp(compId);
  state[compId].supplier = (state[compId].supplier === idx) ? null : idx;
  saveState();
  updateAll();
}

function resetComp(compId) {
  state[compId] = { tasks: {}, supplier: null };
  saveState();
  updateAll();
}

// ─── PROGRESS CALCULATIONS ───
function compProgress(comp) {
  let total = 0, done = 0;
  comp.stages.forEach(st => {
    st.tasks.forEach((_, i) => {
      total++;
      if (isTaskDone(comp.id, st.id, i)) done++;
    });
  });
  return { total, done, pct: total ? Math.round((done / total) * 100) : 0 };
}

function stageProgress(comp, stageId) {
  const st = comp.stages.find(s => s.id === stageId);
  if (!st) return { total: 0, done: 0, pct: 0 };
  let total = st.tasks.length, done = 0;
  st.tasks.forEach((_, i) => { if (isTaskDone(comp.id, st.id, i)) done++; });
  return { total, done, pct: total ? Math.round((done / total) * 100) : 0 };
}

// stage status: 'done' | 'active' | 'todo'
function stageStatus(comp, stageId) {
  const { total, done } = stageProgress(comp, stageId);
  if (done === total && total > 0) return 'done';
  if (done > 0) return 'active';
  return 'todo';
}

// component status for card coloring
function compStatus(comp) {
  const { pct } = compProgress(comp);
  if (pct === 0) return 'todo';
  if (pct === 100) return 'done';
  return 'active';
}

// active stage (first incomplete one)
function activeStage(comp) {
  for (const st of comp.stages) {
    const { total, done } = stageProgress(comp, st.id);
    if (done < total) return st.id;
  }
  return comp.stages[comp.stages.length - 1].id; // all done
}

function globalProgress() {
  let total = 0, done = 0;
  COMPONENTS.forEach(c => {
    const p = compProgress(c);
    total += p.total;
    done += p.done;
  });
  return { total, done, pct: total ? Math.round((done / total) * 100) : 0 };
}

// ═══════════════════════════════════════════════════════════════════════════
//  RENDERING
// ═══════════════════════════════════════════════════════════════════════════

// ─── HEADER ───
function updateHeader() {
  const { total, done, pct } = globalProgress();
  document.getElementById('global-bar').style.width = pct + '%';
  document.getElementById('global-pct').textContent = pct + '%';
  document.getElementById('hdr-pct').textContent = pct + '%';
  document.getElementById('hdr-tasks').textContent = `${done}/${total}`;

  let active = 0;
  COMPONENTS.forEach(c => { if (compStatus(c) === 'active') active++; });
  document.getElementById('hdr-comps').textContent = `${active}/8`;
}

// ─── STATS ROW ───
function updateStats() {
  let nActive = 0, nDone = 0;
  COMPONENTS.forEach(c => {
    const s = compStatus(c);
    if (s === 'active') nActive++;
    if (s === 'done') nDone++;
  });
  const { pct } = globalProgress();
  document.getElementById('stat-active').textContent = nActive;
  document.getElementById('stat-done').textContent = nDone;
  document.getElementById('stat-tasks').textContent = pct + '%';
}

// ─── OVERVIEW GRID ───
function renderOverviewGrid() {
  const grid = document.getElementById('overview-grid');
  grid.innerHTML = COMPONENTS.map(comp => {
    const { pct } = compProgress(comp);
    const status = compStatus(comp);
    const aStage = STAGES.find(s => s.id === activeStage(comp));
    const badgeClass = status === 'done' ? 'badge-done' : status === 'active' ? 'badge-active' : 'badge-todo';
    const badgeText = status === 'done' ? '✓ Completed' : status === 'active' ? `↗ ${aStage.label}` : '— Not Started';
    return `
    <div class="comp-card status-${status}" onclick="switchToComp('${comp.id}')">
      <div class="comp-card-header">
        <div class="comp-icon">${comp.icon}</div>
        <div class="comp-card-header-text">
          <h3>${comp.name}</h3>
          <p>${comp.nameEn}</p>
        </div>
      </div>
      <div class="comp-card-progress">
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted)">
          <span>Progress</span><strong style="color:var(--text)">${pct}%</strong>
        </div>
        <div class="mini-track"><div class="mini-fill" style="width:${pct}%"></div></div>
      </div>
      <div class="comp-card-meta">
        <span class="text-muted">${comp.specs.split('—')[0].trim()}</span>
        <span class="stage-badge ${badgeClass}">${badgeText}</span>
      </div>
    </div>`;
  }).join('');
}

function switchToComp(compId) {
  // Switch to components tab and open that accordion
  switchTab('components');
  setTimeout(() => {
    const el = document.getElementById(`acc-${compId}`);
    if (el && !el.classList.contains('open')) {
      el.classList.add('open');
    }
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 50);
}

// ─── COMPONENT ACCORDION ───
function renderAccordion() {
  const container = document.getElementById('comp-accordion');
  container.innerHTML = COMPONENTS.map(comp => {
    const { pct, done, total } = compProgress(comp);
    const status = compStatus(comp);
    const aStageId = activeStage(comp);
    return `
    <div class="acc-item" id="acc-${comp.id}">
      <div class="acc-header" onclick="toggleAcc('${comp.id}')">
        <div class="acc-icon">${comp.icon}</div>
        <div class="acc-title">
          <h3>${comp.name}</h3>
          <p>${comp.specs}</p>
        </div>
        <div class="acc-meta">
          <span class="stage-badge ${status === 'done' ? 'badge-done' : status === 'active' ? 'badge-active' : 'badge-todo'}">
            ${status === 'done' ? '✓ Completed' : status === 'active' ? '↗ In Progress' : '— Not Started'}
          </span>
          <div class="acc-pct">${pct}%</div>
          <div class="acc-chevron">▾</div>
        </div>
      </div>
      <div class="acc-progress-bar">
        <div class="acc-progress-fill" style="width:${pct}%"></div>
      </div>
      <div class="acc-body">
        ${renderPipeline(comp, aStageId)}
        ${renderTaskSections(comp)}
        ${renderSupplierPicker(comp)}
        <div class="actions-row">
          <button class="btn btn-danger-outline" onclick="if(confirm('Reset ${comp.name}?')) resetComp('${comp.id}')">
            ✕ Reset
          </button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function toggleAcc(compId) {
  const el = document.getElementById(`acc-${compId}`);
  if (el) el.classList.toggle('open');
}

function renderPipeline(comp, activeStageId) {
  return `<div class="stage-pipeline">
    ${STAGES.map(st => {
      const status = stageStatus(comp, st.id);
      const { done, total } = stageProgress(comp, st.id);
      const dot = status === 'done' ? '✓' : status === 'active' ? '▶' : st.icon;
      return `
      <div class="stage-step ${status}">
        <div class="stage-dot">${dot}</div>
        <div class="stage-label">${st.label}<br><span style="font-size:9px;opacity:0.8">${done}/${total}</span></div>
      </div>`;
    }).join('')}
  </div>`;
}

function renderTaskSections(comp) {
  return `<div class="tasks-grid">
    ${comp.stages.map(st => {
      const stage = STAGES.find(s => s.id === st.id);
      const { done, total } = stageProgress(comp, st.id);
      const status = stageStatus(comp, st.id);
      const dotColor = status === 'done' ? 'var(--success)' : status === 'active' ? 'var(--warning)' : 'var(--border)';
      const isOpen = status === 'active' ? ' open' : '';
      return `
      <div class="task-stage-block${isOpen}" id="tsb-${comp.id}-${st.id}">
        <div class="task-stage-header" onclick="toggleTaskStage('${comp.id}','${st.id}')">
          <div class="task-stage-dot" style="background:${dotColor}"></div>
          <h4>${stage.icon} ${stage.label}</h4>
          <span class="task-stage-count">${done}/${total} tasks</span>
          <span class="task-stage-chevron">▾</span>
        </div>
        <div class="task-list">
          ${st.tasks.map((task, i) => {
            const checked = isTaskDone(comp.id, st.id, i);
            return `
            <div class="task-item ${checked ? 'checked' : ''}" id="ti-${comp.id}-${st.id}-${i}">
              <input type="checkbox" id="cb-${comp.id}-${st.id}-${i}"
                ${checked ? 'checked' : ''}
                onchange="toggleTask('${comp.id}','${st.id}',${i})">
              <label for="cb-${comp.id}-${st.id}-${i}">${task}</label>
            </div>`;
          }).join('')}
        </div>
      </div>`;
    }).join('')}
  </div>`;
}

function toggleTaskStage(compId, stageId) {
  const el = document.getElementById(`tsb-${compId}-${stageId}`);
  if (el) el.classList.toggle('open');
}

function renderSupplierPicker(comp) {
  ensureComp(comp.id);
  const selected = state[comp.id].supplier;
  return `
  <div class="supplier-section">
    <h4>🏭 Recommended Suppliers &mdash; select the chosen supplier:</h4>
    <div class="supplier-cards">
      ${comp.suppliers.map((s, i) => `
      <div class="supplier-card ${selected === i ? 'selected' : ''}"
           onclick="setSupplier('${comp.id}', ${i})">
        ${selected === i ? '<span class="supplier-selected-badge">✓ Selected</span>' : ''}
        <h5>${s.name}</h5>
        <div class="s-city">📍 ${s.city}</div>
        <div class="s-spec">${s.specialty}</div>
        <div class="s-contact">✉ ${s.contact} &nbsp;|&nbsp; MOQ: ${s.moq}</div>
        ${s.website ? `<div class="s-website"><a href="${s.website}" target="_blank" onclick="event.stopPropagation()">🌐 ${s.website.replace(/^https?:\/\/(?:www\.)?/, '').replace(/\/$/, '')}</a></div>` : ''}
      </div>`).join('')}
    </div>
  </div>`;
}

// ─── SUPPLIER DIRECTORY ───
function renderSupplierDir() {
  const dir = document.getElementById('supplier-dir');
  dir.innerHTML = COMPONENTS.map(comp => {
    ensureComp(comp.id);
    const selectedIdx = state[comp.id].supplier;
    return `
    <div class="supplier-dir-comp">
      <div class="supplier-dir-comp-header">
        <span class="d-icon">${comp.icon}</span>
        <h3>${comp.name} <span style="opacity:0.6;font-weight:400;font-size:13px">(${comp.nameEn})</span></h3>
        ${selectedIdx !== null ? `<span class="info-chip">✓ Supplier selected</span>` : ''}
      </div>
      <table class="supplier-table">
        <thead>
          <tr>
            <th>Supplier</th>
            <th>City / Province</th>
            <th>Specialty</th>
            <th>Contact</th>
            <th>Website</th>
            <th>MOQ</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          ${comp.suppliers.map((s, i) => `
          <tr class="${selectedIdx === i ? 'selected-row' : ''}">
            <td class="s-name-cell">${s.name}</td>
            <td>${s.city}</td>
            <td style="color:var(--accent-dark)">${s.specialty}</td>
            <td style="font-size:12px">${s.contact}</td>
            <td style="font-size:12px">${s.website ? `<a href="${s.website}" target="_blank" style="color:var(--accent)">${s.website.replace(/^https?:\/\/(?:www\.)?/, '').replace(/\/$/, '')}</a>` : '<span style="color:#ccc">—</span>'}</td>
            <td>${s.moq}</td>
            <td>${selectedIdx === i ? '<span class="s-check">✓ Selected</span>' : '<span style="color:#ccc">—</span>'}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`;
  }).join('');
}

// ─── TIMELINE ───
function renderTimeline() {
  const tbody = document.getElementById('timeline-body');
  tbody.innerHTML = COMPONENTS.map(comp => {
    return `<tr>
      <td><div class="tl-comp-name">${comp.icon} ${comp.name}</div></td>
      ${STAGES.map(st => {
        const status = stageStatus(comp, st.id);
        const { done, total } = stageProgress(comp, st.id);
        let cls = 'tl-todo', txt = '—';
        if (status === 'done')   { cls = 'tl-done';   txt = `✓ ${done}/${total}`; }
        if (status === 'active') { cls = 'tl-active';  txt = `▶ ${done}/${total}`; }
        // tl-todo stays as '—'
        return `<td><span class="tl-cell ${cls}">${txt}</span></td>`;
      }).join('')}
    </tr>`;
  }).join('');
}

// ─── MASTER UPDATE ───
function updateAll() {
  updateHeader();
  updateStats();

  // Patch overview cards (no full re-render to avoid flicker)
  renderOverviewGrid();

  // Patch accordion items — update progress bars, badges, pipelines, tasks in place
  COMPONENTS.forEach(comp => {
    const accEl = document.getElementById(`acc-${comp.id}`);
    if (!accEl) return;
    // Just re-render body content if open
    const body = accEl.querySelector('.acc-body');
    if (body) {
      const { pct } = compProgress(comp);
      const status = compStatus(comp);
      const aStageId = activeStage(comp);
      // update progress bar
      const bar = accEl.querySelector('.acc-progress-fill');
      if (bar) bar.style.width = pct + '%';
      // update pct text
      const pctEl = accEl.querySelector('.acc-pct');
      if (pctEl) pctEl.textContent = pct + '%';
      // update badge
      const badge = accEl.querySelector('.acc-meta .stage-badge');
      if (badge) {
        badge.className = `stage-badge ${status === 'done' ? 'badge-done' : status === 'active' ? 'badge-active' : 'badge-todo'}`;
        badge.textContent = status === 'done' ? '✓ Completed' : status === 'active' ? '↗ In Progress' : '— Not Started';
      }
      // update individual checkboxes and task items
      comp.stages.forEach(st => {
        st.tasks.forEach((_, i) => {
          const cb = document.getElementById(`cb-${comp.id}-${st.id}-${i}`);
          if (cb) cb.checked = isTaskDone(comp.id, st.id, i);
          const ti = document.getElementById(`ti-${comp.id}-${st.id}-${i}`);
          if (ti) ti.className = `task-item ${isTaskDone(comp.id, st.id, i) ? 'checked' : ''}`;
        });
        // update stage task count
        const { done, total } = stageProgress(comp, st.id);
        const tsb = document.getElementById(`tsb-${comp.id}-${st.id}`);
        if (tsb) {
          const cnt = tsb.querySelector('.task-stage-count');
          if (cnt) cnt.textContent = `${done}/${total} tasks`;
          const dot = tsb.querySelector('.task-stage-dot');
          if (dot) {
            const sstatus = stageStatus(comp, st.id);
            dot.style.background = sstatus === 'done' ? 'var(--success)' : sstatus === 'active' ? 'var(--warning)' : 'var(--border)';
          }
        }
      });
      // update supplier picker
      const sp = body.querySelector('.supplier-section');
      if (sp) sp.outerHTML = renderSupplierPicker(comp);
    }
  });

  // Timeline
  renderTimeline();
  // Supplier dir
  renderSupplierDir();
}

// ─── FULL INITIAL RENDER ───
function fullRender() {
  updateHeader();
  updateStats();
  renderOverviewGrid();
  renderAccordion();
  renderSupplierDir();
  renderTimeline();
}

// ═══════════════════════════════════════════════════════════════════════════
//  TABS
// ═══════════════════════════════════════════════════════════════════════════

function switchTab(tabId) {
  document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('#main-tabs button').forEach(btn => btn.classList.remove('active'));
  const section = document.getElementById(`tab-${tabId}`);
  if (section) section.classList.add('active');
  const btn = document.querySelector(`#main-tabs button[data-tab="${tabId}"]`);
  if (btn) btn.classList.add('active');
}

document.getElementById('main-tabs').addEventListener('click', e => {
  const btn = e.target.closest('button[data-tab]');
  if (btn) switchTab(btn.dataset.tab);
});

// fullRender() is called by the Firebase real-time listener once data loads.
</script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ── FIREBASE INIT ──────────────────────────────────────────────────────────
const firebaseConfig = {
  apiKey: "AIzaSyAHITJvSBgKrNYn9Cf3UvBflKbT0AgqPdQ",
  authDomain: "supplychain-8269c.firebaseapp.com",
  databaseURL: "https://supplychain-8269c-default-rtdb.firebaseio.com",
  projectId: "supplychain-8269c",
  storageBucket: "supplychain-8269c.firebasestorage.app",
  messagingSenderId: "629685851701",
  appId: "1:629685851701:web:0f8488620d800f841cc37c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const stateRef = db.ref('babipoly_sc_v2');

// ── SYNC STATUS UI ─────────────────────────────────────────────────────────
function setSyncStatus(mode, label) {
  const el = document.getElementById('sync-status');
  const lbl = document.getElementById('sync-label');
  if (el)  { el.className = ''; el.classList.add(mode); }
  if (lbl) lbl.textContent = label;
}

db.ref('.info/connected').on('value', snap => {
  if (snap.val()) {
    setSyncStatus('online', 'Online');
  } else {
    setSyncStatus('offline', 'Offline');
  }
});

// ── DEBOUNCED SAVE ─────────────────────────────────────────────────────────
let _saveTimer = null;
function saveState() {
  setSyncStatus('syncing', 'Sync...');
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(() => {
    stateRef.set(state)
      .then(() => setSyncStatus('online', 'Online'))
      .catch(() => setSyncStatus('offline', 'Error'));
  }, 400);
}

// ── REAL-TIME LISTENER ─────────────────────────────────────────────────────
let _firstLoad = true;

function hideOverlayAndRender() {
  if (!_firstLoad) return;
  _firstLoad = false;
  const overlay = document.getElementById('loading-overlay');
  if (overlay) {
    overlay.classList.add('hidden');
    setTimeout(() => overlay.remove(), 450);
  }
  fullRender();
}

// Timeout fallback: render with local/empty state if Firebase doesn't respond in 4s
const _fbTimeout = setTimeout(() => {
  if (_firstLoad) {
    try {
      const local = localStorage.getItem('babipoly_sc_v2');
      if (local) state = JSON.parse(local);
    } catch (e) {}
    setSyncStatus('offline', 'Offline');
    hideOverlayAndRender();
  }
}, 4000);

stateRef.on('value', snapshot => {
  clearTimeout(_fbTimeout);
  state = snapshot.val() || {};

  if (_firstLoad) {
    // Migrate any existing localStorage data if Firebase is empty
    if (Object.keys(state).length === 0) {
      try {
        const local = localStorage.getItem('babipoly_sc_v2');
        if (local) {
          state = JSON.parse(local);
          stateRef.set(state); // push local data up to Firebase
        }
      } catch (e) {}
    }
    hideOverlayAndRender();
  } else {
    // Remote update from another device — re-render
    updateAll();
  }
});
</script>
</body>
</html>
